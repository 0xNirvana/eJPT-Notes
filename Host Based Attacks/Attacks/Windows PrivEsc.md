## Kernel Exploits
- All Windows machine use Windows NT kernel
- Two modes
	- User modde: applications have limited access to system resources and functionalities
	- Kernel Mode: Unrestricted access to system resources
- Two steps:
	- Identifying kernel vulnerabilities
	- Downloading, compiling and transferring onto target system
- Tools
	- #tools/enum/windows/Windows-Exploit-Suggester
	- [SecWiki Windows Kernel Exploits](https://github.com/SecWiki/windows-kernel-exploits)

### Exploitation w/ Metasploit
- Gain access on a taget machine with #tools/multi/msfconsole and use `local_exploit_suggester`
- Select the existing session and it will show the exploits that you can perform on the target machine
- From the list of exploits, select one and run it

### Exploitation w/ Windows Exploit Suggester
- Get `systeminfo` from the target machine and copy it to a new file
- Run #tools/enum/windows/Windows-Exploit-Suggester to parse the system info
	```
	# ./windows-exploit-suggester.py --update
	# ./windows-exploit-suggester.py --database <date>-mssb.xls --systeminfo <your_file_name>
	```
- From the provided links
	- Download and complie the exploit code or download the executable
	- Run it on the target machine
> Dont run kernel exploits in prod

## Bypass UAC w/ #tools/exploit/windows/UACMe
- UAC
	- User Access Control
	- Makes sure that changes to OS require approval from the administrator or user is part of local admin group
	- To bypass UAC, you need an account that is part of local administrator group
	- Attacks depend on the target OS and how UAC is configured

### Exploitation
- Check users
	```
	> net users
	> net localgroup administrators
	```
- Gain initial foothold on the machine using manual exploit or metasploit.
- Check `sysinfo` and find the process ID of `explorer` and migrate to that PID
	```
	> pgrep explorer
	> migrate <explorer's PID>
	```
- Check if the user is part of `Admin` group.
> `System error 5 has occured`: You get this error when you can't submit the UAC consent
- Upload the binary `akagai64.exe` to the target machine
- Create a backdoor that you can run with escalated privileges ![[MSFVenom#Windows Reverse Shell exe]]
- Start UACMe
	- From their [GitHub](https://github.com/hfiref0x/UACME/tree/v3.2.x), find the right exploit key that will work on your target machine
	- Run the exploit
		```
		> .\Akagai64.exe <key> <full_backdoor_path>
		```
- There you get the escalated reverse shell and then migrate to another process

## Windows Access Token
- Created and managed by LSASS (Local Security Authority and Subsystem Service)
- Responsible for identifying and describing the security context of a process or thread
- Access tokens are generated by winlogon.exe everytime a user authenticates successfully and it includes the identity and privileges of that account. This token is then attached to the userinit.exe process after which all proceses started by that user will inherit a copy of the same token
- Levels
	- Impersonate: created through non-interactive log on Windows (thru system service or domain logons)
	- Delegate: created through interactive login (traditional login or RDP)
- Privileges required for impersonation attack
	- `SeAssignPrimaryToken`: allows to impersonate tokens
	- `SeCreateToken`: allows to create an arbitrary token with administrative privileges
	- `SeImpersonatePrivilege`: allows user to create a process under security context of another user w/ administrative privilege
- Use `Incognito Module` ![[Modules#Incognito Module]]
## Windows Alternate Data Streams
- ADS is an NTFS file attribute
- Any file has two forks/streams
	- Data stream: containing the data
	- Resource stream: metadata
- ADS can be used to hide malicious code by hiding it in the metadata
- Used to evade AV and static scanning

### Exploitation
- Create a new text or anything file and write anything
	```
	> notepad text.txt # write data to it and whenever you open it you will see the data
	```
- Create another hidden file
	```
	> notepad test.txt:secret.txt # write data to the new file
	```
	- After saving this file, you will only see `test.txt` was created but not `secret.txt`. Also, when you open `test.txt`, you won't see the content that you had written previously.
	- To open the hidden file run the same notepad command again
- Hide a binary in metadata of another file
	```
	type malicious.exe > normal.txt:malicious.exe
	```
- Run the executable
	```
	> C:\Windows\System32
	> mlink wupdate.exe C:\Temp\normal.txt:malicious.exe
	> wupdate # this will execute the malicious file
```